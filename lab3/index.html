<!DOCTYPE html>
<html>
    <body>
        <canvas id="myCanvas" width="800" height="600">
            <script>
                var canvas = document.getElementById("myCanvas");
                var ctx = canvas.getContext("2d");

                var playerPosition = canvas.clientWidth / 2;
                const velocity = 30;
                const playerSize = 20;
                var ballX, ballY, bulletX, bulletY, bulletInMove = false;
                function drawPlayer(size, ctx)
                {
                    ctx.beginPath();
                    ctx.fillRect(playerPosition, canvas.clientHeight - size, size, size);
                    ctx.fillStyle = "red";
                    ctx.stroke();
                    requestAnimationFrame(()=>{
                        ctx.clearRect(0, 0, canvas.clientWidth, canvas.clientHeight);
                        drawPlayer(size, ctx);
                    })
                }

                function detectCollisionOfBallAndBullet() {

                }

                function drawBullet(radius) {
                    console.log("hello bullet");
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(bulletX, bulletY, radius, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.stroke();
                    bulletY -= 1;
                    if (bulletY < 0)
                        bulletInMove = false;

                    if (bulletInMove) {
                        requestAnimationFrame(()=>{
                            drawBullet(radius);
                        });                        
                    }
                }

                function spawnBullet() {
                    bulletX = playerPosition;
                    bulletY = canvas.clientHeight;
                    bulletInMove = false;
                    requestAnimationFrame(()=>{
                        drawBullet(radius);
                    })
                }

                function drawBall(radius) {
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(ballX, ballY, radius, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.stroke();
                    ballY += 1;
                    if (ballY > canvas.clientHeight) {
                        spawnBall();
                        console.log("hello");
                    }
                    requestAnimationFrame(()=>{
                        drawBall(radius);
                    })
                }
                document.addEventListener('keydown', (event)=> {
                    if (event.defaultPrevented) { return; }
                    switch (event.key) {
                        case "ArrowLeft":
                            if (playerPosition - playerSize > 0) {
                                playerPosition -= velocity;
                            }
                            break;
                        case "ArrowRight":
                            if (playerPosition + playerSize < canvas.clientWidth) {
                                playerPosition += velocity;
                            }
                            break;
                        case " ":
                            if (!bulletInMove)
                                    spawnBullet(radius);
                    }

                    event.preventDefault();
                }, true);

                function spawnBall() {
                    ballX = Math.floor(Math.random() * canvas.clientWidth);
                    ballY = 0;
                    ballInMove = true;
                }

                requestAnimationFrame(() => {
                    spawnBall();
                    drawPlayer(playerSize, ctx);
                    drawBall(20);
                });

                const radius = 40;
                const NUMBER_OF_STEPS = 5
                const stepOffset = (canvas.clientHeight - radius * 2) / NUMBER_OF_STEPS;
                var lastStepBorderX;
                function drawStep(stepNumber) {
                    ctx.save();
                    ctx.beginPath();
                    ctx.fillStyle = "red";
                    ctx.fill();
                    const calcOff = stepOffset * stepNumber;
                    ctx.fillRect(
                        calcOff,
                        canvas.clientHeight - calcOff,
                        canvas.clientWidth - calcOff,
                        stepOffset);
                    ctx.stroke();
                    if (stepNumber < NUMBER_OF_STEPS) {
                        setTimeout(() => {
                            requestAnimationFrame(()=>{drawStep(stepNumber + 1)});
                        }, 1000);
                    } else {
                        lastStepBorderX = calcOff;
                        lastStepBorderY = canvas.clientHeight - calcOff;
                        requestAnimationFrame(moveBall);
                    }
                        
                }

                function DrawStairs() {
                    ctx.save();
                    ctx.beginPath();
                    ctx.fillStyle = "red";
                    for (var i = 0; i < NUMBER_OF_STEPS + 1; ++i) {
                        const calcOff = stepOffset * i;
                        ctx.fillRect(
                        calcOff,
                        canvas.clientHeight - calcOff,
                        canvas.clientWidth - calcOff,
                        stepOffset);
                    }
                    ctx.stroke();
                }



                var ballPosX = canvas.clientWidth - radius, ballPosY = radius;
                var moveForward = true;
                function moveBall() {
                    ctx.clearRect(0, 0, canvas.clientWidth, canvas.clientHeight);
                    DrawStairs();
                    drawBall(ballPosX, ballPosY);
                    if (ballPosX + radius < lastStepBorderX) {
                        moveForward = false;
                        lastStepBorderX -= stepOffset;
                        lastStepBorderY += stepOffset;
                    }
                    if (!moveForward && ballPosY + radius == lastStepBorderY) {
                        moveForward = true;
                    }
                    if (moveForward)
                        ballPosX -= 1;
                    else
                        ballPosY += 1;
                    requestAnimationFrame(moveBall);
                }                
            </script>
        </canvas>
    </body>
</html>